<h3 class="fw-bold">Expenses</h3>
<c-accordion class="mb-4">
    <c-accordion-item #item0="cAccordionItem" [visible]="true">
        <ng-template cTemplateId="accordionHeaderTemplate">
            <button (click)="item0.toggleItem()" [collapsed]="!item0.visible" cAccordionButton>
                Filter:
            </button>
        </ng-template>
        <ng-template cTemplateId="accordionBodyTemplate">
            <div class="accordion-body">
                <div class="row">
                    <div class="col-8">
                        <form cForm [formGroup]="filterForm" (ngSubmit)="filter()">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <app-range-datetime-picker [showTime]="false"></app-range-datetime-picker>
                                </div>
                                <div class="col-4">
                                    <app-tree-select-v1 [options]="categoryTreeOptions"
                                        (onChangeValue)="onChangeSelectOption($event,'filter')"></app-tree-select-v1>
                                </div>
  
                            </div>
                            <div class="row">
                              <div class="col-4">
                                    <input formControlName="searchText" type="text" class="form-control"
                                        placeholder="Search by name...">
                                </div>
                                <div class="col-4">
                                    <button type="submit" class="btn btn-primary">
                                        <svg [cIcon]="icons.cilSearch" width="20" class="text-white"
                                            title="Search Icon"></svg>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-4">
                        <div class="justify-content-end d-flex">
                            <button class="btn btn-success" (click)="toggleLiveCreateModel()">
                                <svg [cIcon]="icons.cilPlus" width="25" class="text-white" title="Plus Icon"></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>
    </c-accordion-item>
</c-accordion>

<app-data-table [data]="pageInformation" (changePageIndex)="onPageIndexChange($event)"
    (changePageSize)="onPageSizeChange($event)">
    <thead class="text-nowrap text-truncate">
        <tr>
            <th scope="col">No.</th>
            <th scope="col">Category</th>
            <th scope="col">SubCategory</th>
            <th scope="col">Amount</th>
            <th scope="col">Date</th>
            <th scope="col">Created At</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @for (item of data.items; track item.id) {
        <tr>
            <td>{{ $index+1 }}</td>
            <td>{{getCategoryNameById(item.categoryId)}}</td>
            <td>{{getSubCategoryNameById(item.categoryId, item.subCategoryId)}}</td>
            <td>{{ item.amount | number}}</td>
            <td>{{ item.date | date:'MM/dd/yyyy' }}</td>
            <td>{{ item.createdAt | date:'MM/dd/yyyy' }}</td>
            <!-- <td> 
                {{item.note | slice:0:40}}
                @if (item.note && item.note.length > 40) {
                <span>...</span>
                }
            </td> -->
            <td>
                <div class="d-flex justify-content-end">
                    <!-- @if((item?.questionLibraries?.length ?? 0) > 0) {
                        <button (click)="toggleNode(item)" class="btn btn-info me-2">
                            <app-book-icon [open]="item.expanded"></app-book-icon>
                        </button>
                    } -->
                    <button (click)="updateData(item.id)" class="btn btn-primary me-2">
                        <svg [cIcon]="icons.cilPen" width="25" class="text-white" title="Edit Icon"></svg>
                    </button>
                    <button (click)="deleteData(item.id)" class="btn btn-danger">
                        <svg [cIcon]="icons.cilTrash" width="25" class="text-white" title="Delete Icon"></svg>
                    </button>
                </div>
            </td>
        </tr>
        <!-- <ng-container [ngTemplateOutlet]="nodeTemplate"
            [ngTemplateOutletContext]="{ node: item, level: 1 }"></ng-container> -->
        }
    </tbody>
</app-data-table>

<!-- Create Modal -->
<c-modal backdrop="static" [visible]="visibleCreateModal" (visibleChange)="handleLiveCreateModelChange($event)"
    id="verticallyCenteredCreateModal" size="lg">
    <c-modal-header class="bg-success d-flex justify-content-between align-items-center">
        <h5 cModalTitle class="fw-bold text-white">Add Expense</h5>
        <button (click)="toggleLiveCreateModel()" class="btn btn-sm btnClose">
            <svg [cIcon]="icons.cilX" width="22" class="text-white" title="Close Icon"></svg>
        </button>
    </c-modal-header>
    <form cForm [formGroup]="createForm" (ngSubmit)="onSubmitCreateForm()">
        <c-modal-body>
            <div class="mb-2">
                <label cLabel>Category: <span class="text-danger">(*)</span></label>
                <app-tree-select-v1 [options]="categoryTreeOptions"
                    (onChangeValue)="onChangeSelectOption($event, 'create')"></app-tree-select-v1>
            </div>
            <div class="mb-2 row">
                <div class="col-6">
                    <label cLabel>Amount: <span class="text-danger">(*)</span></label>
                    <app-input-currency (valueChange)="createForm.patchValue({amount: $event})"></app-input-currency>
                </div>
                <div class="col-6">
                    <label cLabel for="date">Date: <span class="text-danger">(*)</span></label>
                    <input cFormControl formControlName="date" type="date">
                </div>
            </div>
            <div class="mb-2">
                <label cLabel for="note">Note: </label>
                <textarea cFormControl formControlName="note" rows="3"></textarea>
                @if (noteCreateForm?.invalid && (noteCreateForm?.dirty || noteCreateForm?.touched)) {
                <div class="text-danger">
                    @if (noteCreateForm?.hasError('maxlength')) {
                    Maximum 500 characters.
                    }
                </div>
                }
            </div>
        </c-modal-body>
        <c-modal-footer>
            <button (click)="toggleLiveCreateModel()" cButton color="secondary">
                <svg [cIcon]="icons.cilExitToApp" width="22" class="text-white" title="Close Icon"></svg>
            </button>
            <button cButton type="submit" color="primary" [disabled]="!createForm.valid">
                <svg [cIcon]="icons.cilSave" width="22" class="text-white" title="Save Icon"></svg>
            </button>
        </c-modal-footer>
    </form>
</c-modal>
<!--Update Model-->
<c-modal backdrop="static" [visible]="visibleUpdateModal" (visibleChange)="handleLiveUpdateModelChange($event)"
    id="verticallyCenteredUpdateModal" size="lg">
    <c-modal-header class="bg-primary d-flex justify-content-between align-items-center">
        <h5 cModalTitle class="text-white fw-bold">Update Expense</h5>
        <button (click)="toggleLiveUpdateModel()" class="btn btn-sm btnClose">
            <svg [cIcon]="icons.cilX" width="22" class="text-white" title="Close Icon"></svg>
        </button>
    </c-modal-header>
    <form cForm [formGroup]="updateForm" (ngSubmit)="onSubmitUpdateForm()">
        <c-modal-body>

            <div class="mb-2">
                <label cLabel>Category: <span class="text-danger">(*)</span></label>
                <app-tree-select-v1 [options]="categoryTreeOptions"
                    (onChangeValue)="onChangeSelectOption($event, 'update')"></app-tree-select-v1>

            </div>

            <div class="mb-2 row">
                <div class="col-6">
                    <label cLabel>Amount: <span class="text-danger">(*)</span></label>
                    <!-- <input cFormControl formControlName="amount"> -->
                    <app-input-currency></app-input-currency>
                </div>
                <div class="col-6">
                    <label cLabel for="date">Date: <span class="text-danger">(*)</span></label>
                    <input cFormControl formControlName="date" type="date">
                </div>
            </div>
            <div class="mb-2">
                <label cLabel for="note">Note: </label>
                <textarea cFormControl formControlName="note" rows="3"></textarea>
                @if (noteUpdateForm?.invalid && (noteUpdateForm?.dirty || noteUpdateForm?.touched)) {
                <div class="text-danger">
                    @if (noteUpdateForm?.hasError('maxlength')) {
                    Maximum 500 characters.
                    }
                </div>
                }
            </div>

        </c-modal-body>
        <c-modal-footer>
            <button (click)="toggleLiveUpdateModel()" cButton color="secondary">
                <svg [cIcon]="icons.cilExitToApp" width="22" class="text-white" title="Close Icon"></svg>
            </button>
            <button cButton type="submit" [disabled]="!updateForm.valid" color="primary">
                <svg [cIcon]="icons.cilSave" width="22" class="text-white" title="Save Icon"></svg>
            </button>
        </c-modal-footer>
    </form>
</c-modal>
<!--Delete Model-->
<c-modal backdrop="static" [visible]="visibleDelete" (visibleChange)="handleLiveDeleteChange($event)"
    id="verticallyCenteredDelete">
    <c-modal-header class="bg-danger d-flex justify-content-between align-items-center">
        <h5 cModalTitle class="fw-bold text-white">Delete Expense</h5>
        <button (click)="toggleLiveDelete()" class="btn btn-sm btnClose">
            <svg [cIcon]="icons.cilX" width="22" class="text-white" title="Close Icon"></svg>
        </button>
    </c-modal-header>
    <c-modal-body>
        <p>Are you sure you want to delete this expense?</p>
    </c-modal-body>
    <c-modal-footer>
        <button (click)="toggleLiveDelete()" cButton color="secondary">
            <svg [cIcon]="icons.cilExitToApp" width="22" class="text-white" title="Close Icon"></svg>
        </button>
        <button (click)="onConfirmDelete()" cButton color="danger">
            <svg [cIcon]="icons.cilTrash" width="22" class="text-white" title="Delete Icon"></svg>
        </button>
    </c-modal-footer>
</c-modal>